const findBlockByAlias = (alias) => {
    return $(".reviews__item").filter((ndx, item) => {
        return $(item).attr("data-linked-with") === alias;
    });
};

$(".interactive-avatar__link").click((e) => {
    e.preventDefault();

    const $this = $(e.currentTarget);
    const target = $this.attr("data-open");
    const itemToShow = findBlockByAlias(target);
    const curItem = $this.parent();

    itemToShow.addClass("active").siblings().removeClass("active");
    curItem.addClass("active").siblings().removeClass("active");
})

const team = document.querySelector('.team');
const teamLink = document.querySelector('.team__link');

team.addEventListener('click', e => {
    e.preventDefault();
    const link = e.target;
    const listItem = e.currentTarget;

    if(link.classList.contains('team__link')) {
        const active = listItem.querySelector('.team__item.team__item--is-active');

        if(active) {
            let activeInfo = active.querySelector('.team__info');
            activeInfo.style.height = '0px';
            active.classList.remove('team__item--is-active');
        }

        if(!active || active.querySelector('.team__link') !== link) {
            let current = link.closest('.team__item');
            current.classList.add('team__item--is-active');
            let currentText = current.querySelector('.team__info');
            currentText.style.height = currentText.scrollHeight + 'px';
        }
    }
});

$(document).ready(function(){
    $('.slider-section__slider-control').slick(
        {
            nextArrow: $(".slider-section__right-arrow"),
            prevArrow: $(".slider-section__left-arrow"),
            centerMode: true,
            respondTo: 'min',
            centerPadding: '-5rem'
        }
    );
});


const validateFields = (form, fieldsArray) => {

    fieldsArray.forEach((field) => {
        field.removeClass('input-error');

        if (typeof field.val() === 'string') {
            if (field.val().trim() === '') {
                field.addClass('input-error')
            }
        }
        else if (typeof field.val() === 'undefined')
        {
            field.addClass('input-error')
        }
    });

    const errorFields = form.find('.input-error');

    return errorFields.length === 0;
}


$('.form').submit(e => {
    e.preventDefault();

    const form = $(e.currentTarget);
    const name = form.find("[name='name']");
    const phone = form.find("[name='phone']");
    const comment = form.find("[name='comment']");
    const to = form.find("[name='to']");

    const popup = $('#popup');
    const content = popup.find('.popup__text');
    popup.removeClass('error-popup');

    const isValid = validateFields(form, [name, phone, comment, to]);
    const statusAjaxForm = {};

    if (isValid) {
        const request = $.ajax({
            url:'https://webdev-api.loftschool.com/sendmail',
            method: 'post',
            data: {
                name: name.val(),
                phone: phone.val(),
                comment: comment.val(),
                to: to.val().trim(),
            },
            error: data => {}
        });

        request.done(data => {
            content.text(data.message);
            statusAjaxForm.done = true;
            popup.find('.popup__text').removeClass('error-popup');
        });

        request.fail(data => {
            statusAjaxForm.done = false;
            const message = data.responseJSON.message;
            content.text(message);
            popup.find('.popup__text').addClass('error-popup');
        });

        request.always(() => {
            $.fancybox.open({
                src: '#popup',
                type: 'inline',

                afterClose: function () {
                    if (statusAjaxForm.done)
                    {
                        form[0].reset();
                    }
                }
            });
        })
    }
});

$('.form__input').change(e => {
    $this = $(e.currentTarget);
    $this.removeClass('input-error');
});


$('.js-btn-submit').click(e => {
    e.preventDefault();

    $.fancybox.close();
});

const burgerBtn = $('#burger');
const hamburger = $('.hamburger-panel');
const closeBtn = $('.close-btn');
const hambLink = $('.hamburger-panel__link');

function switcher(elem, className) {
    elem.toggleClass(className);
}

let flag = true;

burgerBtn.click( e => {
    e.preventDefault();

    if(flag) {
        flag = false;
        hamburger.removeClass('hidden');
        setTimeout(function() {
            switcher(hamburger, 'isActive');
            flag = true;
        }, 500);
    }
});

closeBtn.click( e => {
    e.preventDefault();

    if(flag) {
        flag = false;
        hamburger.removeClass('isActive');
        setTimeout(function() {
            switcher(hamburger, 'hidden');
            flag = true;
        }, 500);
    }

});

hambLink.click( e => {
    hamburger.removeClass('isActive');
    setTimeout(function() {
        switcher(hamburger, 'hidden');
        flag = false;
        }, 500);
});


$(".inc-panel").each(function () {
    $(this).on('mouseover', function() {
        $(this).find(".inc-menu").css({display: 'flex'});
    });
    $(this).on('mouseout', function() {
        $(this).find(".inc-menu").css({display: 'none'});
    });
})


let player;
const playerContainer = $(".player");
let f= 1;

let eventsInit = () => {
    $(".player__start").click(e => {
        e.preventDefault();

        if (playerContainer.hasClass("paused")) {
            player.pauseVideo();
        } else {
            player.playVideo();
        }
    });

    $(".player__playback").click(e => {
        const bar = $(e.currentTarget);
        const clickedPosition = e.originalEvent.layerX;
        const newButtonPositionPercent = (clickedPosition / bar.width()) * 100;
        const newPlaybackPositionSec =
            (player.getDuration() / 100) * newButtonPositionPercent;

        $(".player__playback-button").css({
            left: `${newButtonPositionPercent}%`
        });

        player.seekTo(newPlaybackPositionSec);
    });

    $(".player__splash").click(e => {
        player.playVideo();
    })
};

const formatTime = timeSec => {
    const roundTime = Math.round(timeSec);

    const minutes = addZero(Math.floor(roundTime / 60));
    const seconds = addZero(roundTime - minutes * 60);

    function addZero(num) {
        return num < 10 ? `0${num}` : num;
    }

    return `${minutes} : ${seconds}`;
};

const onPlayerReady = () => {
    let interval;
    const durationSec = player.getDuration();

    $(".player__duration-estimate").text(formatTime(durationSec));

    if (typeof interval !== "undefined") {
        clearInterval(interval);
    }

    interval = setInterval(() => {
        const completedSec = player.getCurrentTime();
        const completedPercent = (completedSec / durationSec) * 100;

        $(".player__playback-button").css({
            left: `${completedPercent}%`
        });

        $(".player__duration-completed").text(formatTime(completedSec));
    }, 1000);
};

const onPlayerStateChange = event => {
    /*
      -1 (воспроизведение видео не начато)
      0 (воспроизведение видео завершено)
      1 (воспроизведение)
      2 (пауза)
      3 (буферизация)
      5 (видео подают реплики).
    */
    switch (event.data) {
        case 1:
            playerContainer.addClass("active");
            playerContainer.addClass("paused");
            break;

        case 2:
            playerContainer.removeClass("active");
            playerContainer.removeClass("paused");
            break;
    }
};

function onYouTubeIframeAPIReady() {
    player = new YT.Player("yt-player", {
        height: "405",
        width: "660",
        videoId: "LXb3EKWsInQ",
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange
        },
        playerVars: {
            controls: 0,
            disablekb: 0,
            showinfo: 0,
            rel: 0,
            autoplay: 0,
            modestbranding: 0
        }
    });
}

eventsInit();

let myMap;
const init = () => {
    myMap = new ymaps.Map("map", {
        center: [59.93916998692174, 30.309015096732622],
        zoom: 11,
        controls: [],
    });

    let coords = [
            [59.94554327989287, 30.38935262114668],
            [59.91142323563909, 30.50024587065841],
            [59.88693161784606, 30.319658102103713],
            [59.97033574821672, 30.315194906302924],
        ],
        myCollection = new ymaps.GeoObjectCollection({}, {
            draggable: false,
            iconLayout: 'default#image',
            iconImageHref: './img/icons/marker.svg',
            iconImageSize: [46, 57],
            iconImageOffset: [-35, -52]
        });

    for (let i = 0; i < coords.length; i++) {
        myCollection.add(new ymaps.Placemark(coords[i]));
    }

    myMap.geoObjects.add(myCollection);

    myMap.behaviors.disable('scrollZoom');
};

ymaps.ready(init);


function accord(selector) {
    const accord = document.querySelector(selector);
    const items = accord.querySelector('[data-list]').children;
    const closeButton = document.querySelector('.accord__close-btn');

    accord.addEventListener('click', function(e) {
        e.preventDefault ();
        const target = e.target.closest('[data]');

        if (e.target.classList.contains('accord__close-btn'))
        {
            e.target.parentNode.parentNode.parentNode.classList.remove('item-active')
        }

        if(!target) return;

        const item = target.parentNode;

        if (item.classList.contains('item-active')) {
            item.classList.remove('item-active');
        }else {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('item-active');
            }

            item.classList.add('item-active');
        }
    });

}

accord ('#accord-menu')

const sections = $("section");
const display = $(".maincontent");
const sideMenu = $(".fixed-menu");
const menuItems = sideMenu.find(".fixed-menu__item");

const mobiled = new MobileDetect(window.navigator.userAgent);
const isMobile = mobiled.mobile();

let inScroll = false;

sections.first().addClass("active");

const countSectionPosition = sectionEq => {

    return sectionEq * -100;

    //let hei = activeSection.next().height();
};

const changeMenuThemeForSection = (sectionEq) => {
    const currentSection = sections.eq(sectionEq);
    const menuTheme = currentSection.attr("data-sidemenu-theme");
    const activeClass = "fixed-menu--shadowed";

    if (menuTheme === "black") {
        sideMenu.addClass(activeClass);
    } else {
        sideMenu.removeClass(activeClass);
    }
};

const resetActiveClassForItem = (items, itemEq, activeClass) => {
    items.eq(itemEq).addClass(activeClass).siblings().removeClass(activeClass);
}

const performTransition = sectionEq => {

    if (inScroll) return;

    const transitionOver = 1000;
    const mouseInertiaOver = 300;

    inScroll = true;

    const position = countSectionPosition(sectionEq);

    changeMenuThemeForSection(sectionEq);


    display.css({
        transform: `translateY(${position}%)`
    });

    resetActiveClassForItem(sections, sectionEq, "active");
    sections.eq(sectionEq).addClass("active").siblings().removeClass("active");


    setTimeout(() => {
        inScroll = false;

        resetActiveClassForItem(menuItems, sectionEq, "fixed-menu__item--active");

    }, transitionOver + mouseInertiaOver)

};

const scrollViewport = direction => {
    const activeSection = sections.filter(".active");
    const nextSection = activeSection.next();
    const prevSection = activeSection.prev();

    if (direction === "next" && nextSection.length) {
        performTransition(nextSection.index());
    }

    if (direction === "prev" && prevSection.length) {
        performTransition(prevSection.index());
    }
};

$(window).on("wheel", e => {
    const deltaY = e.originalEvent.deltaY;

    if (deltaY > 0) {
        scrollViewport("next");
    }

    if (deltaY < 0) {
        scrollViewport("prev");
    }
});

$(window).on("keydown", e => {

    const tagname = e.target.tagName.toLowerCase();
    const userTypingInInputs = tagname === "input" || tagname === "textarea";
    if (userTypingInInputs) return;

    switch (e.keyCode) {
        case 38:
            scrollViewport("prev");
            break;
        case 40:
            scrollViewport("next");
            break;
    }
});

$(".wrapper").on("touchmove", e => e.preventDefault());

$("[data-scroll-to]").click(e => {
    e.preventDefault();

    const $this = $(e.currentTarget);
    const target = $this.attr("data-scroll-to");
    const reqSection = $(`[data-section-id=${target}]`);

    performTransition(reqSection.index());

});

if (isMobile)
{
    $("body").swipe({
        swipe: function (event, direction) {
            if (direction === "up")
            {
                scrollViewport("next");
            }
            if (direction === "down")
            {
                scrollViewport("prev");
            }
        }
    });
}



//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRhYnMuanMiLCJzbGlkZXRvZ2dsZS5qcyIsInNsaWRlci5qcyIsIm9yZGVyLmpzIiwiYnVyZ2VyLmpzIiwibW9kdWxlLmpzIiwicGxlZXIuanMiLCJtYXAuanMiLCJhY2NvcmQuanMiLCJvcHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDakJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDWEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDN0NBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNWQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaEhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZmluZEJsb2NrQnlBbGlhcyA9IChhbGlhcykgPT4ge1xyXG4gICAgcmV0dXJuICQoXCIucmV2aWV3c19faXRlbVwiKS5maWx0ZXIoKG5keCwgaXRlbSkgPT4ge1xyXG4gICAgICAgIHJldHVybiAkKGl0ZW0pLmF0dHIoXCJkYXRhLWxpbmtlZC13aXRoXCIpID09PSBhbGlhcztcclxuICAgIH0pO1xyXG59O1xyXG5cclxuJChcIi5pbnRlcmFjdGl2ZS1hdmF0YXJfX2xpbmtcIikuY2xpY2soKGUpID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICBjb25zdCAkdGhpcyA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IHRhcmdldCA9ICR0aGlzLmF0dHIoXCJkYXRhLW9wZW5cIik7XHJcbiAgICBjb25zdCBpdGVtVG9TaG93ID0gZmluZEJsb2NrQnlBbGlhcyh0YXJnZXQpO1xyXG4gICAgY29uc3QgY3VySXRlbSA9ICR0aGlzLnBhcmVudCgpO1xyXG5cclxuICAgIGl0ZW1Ub1Nob3cuYWRkQ2xhc3MoXCJhY3RpdmVcIikuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcclxuICAgIGN1ckl0ZW0uYWRkQ2xhc3MoXCJhY3RpdmVcIikuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcclxufSlcclxuIiwiY29uc3QgdGVhbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWFtJyk7XHJcbmNvbnN0IHRlYW1MaW5rID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRlYW1fX2xpbmsnKTtcclxuXHJcbnRlYW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGNvbnN0IGxpbmsgPSBlLnRhcmdldDtcclxuICAgIGNvbnN0IGxpc3RJdGVtID0gZS5jdXJyZW50VGFyZ2V0O1xyXG5cclxuICAgIGlmKGxpbmsuY2xhc3NMaXN0LmNvbnRhaW5zKCd0ZWFtX19saW5rJykpIHtcclxuICAgICAgICBjb25zdCBhY3RpdmUgPSBsaXN0SXRlbS5xdWVyeVNlbGVjdG9yKCcudGVhbV9faXRlbS50ZWFtX19pdGVtLS1pcy1hY3RpdmUnKTtcclxuXHJcbiAgICAgICAgaWYoYWN0aXZlKSB7XHJcbiAgICAgICAgICAgIGxldCBhY3RpdmVJbmZvID0gYWN0aXZlLnF1ZXJ5U2VsZWN0b3IoJy50ZWFtX19pbmZvJyk7XHJcbiAgICAgICAgICAgIGFjdGl2ZUluZm8uc3R5bGUuaGVpZ2h0ID0gJzBweCc7XHJcbiAgICAgICAgICAgIGFjdGl2ZS5jbGFzc0xpc3QucmVtb3ZlKCd0ZWFtX19pdGVtLS1pcy1hY3RpdmUnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKCFhY3RpdmUgfHwgYWN0aXZlLnF1ZXJ5U2VsZWN0b3IoJy50ZWFtX19saW5rJykgIT09IGxpbmspIHtcclxuICAgICAgICAgICAgbGV0IGN1cnJlbnQgPSBsaW5rLmNsb3Nlc3QoJy50ZWFtX19pdGVtJyk7XHJcbiAgICAgICAgICAgIGN1cnJlbnQuY2xhc3NMaXN0LmFkZCgndGVhbV9faXRlbS0taXMtYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIGxldCBjdXJyZW50VGV4dCA9IGN1cnJlbnQucXVlcnlTZWxlY3RvcignLnRlYW1fX2luZm8nKTtcclxuICAgICAgICAgICAgY3VycmVudFRleHQuc3R5bGUuaGVpZ2h0ID0gY3VycmVudFRleHQuc2Nyb2xsSGVpZ2h0ICsgJ3B4JztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pO1xyXG4iLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpe1xyXG4gICAgJCgnLnNsaWRlci1zZWN0aW9uX19zbGlkZXItY29udHJvbCcpLnNsaWNrKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgbmV4dEFycm93OiAkKFwiLnNsaWRlci1zZWN0aW9uX19yaWdodC1hcnJvd1wiKSxcclxuICAgICAgICAgICAgcHJldkFycm93OiAkKFwiLnNsaWRlci1zZWN0aW9uX19sZWZ0LWFycm93XCIpLFxyXG4gICAgICAgICAgICBjZW50ZXJNb2RlOiB0cnVlLFxyXG4gICAgICAgICAgICByZXNwb25kVG86ICdtaW4nLFxyXG4gICAgICAgICAgICBjZW50ZXJQYWRkaW5nOiAnLTVyZW0nXHJcbiAgICAgICAgfVxyXG4gICAgKTtcclxufSk7XHJcbiIsIlxyXG5jb25zdCB2YWxpZGF0ZUZpZWxkcyA9IChmb3JtLCBmaWVsZHNBcnJheSkgPT4ge1xyXG5cclxuICAgIGZpZWxkc0FycmF5LmZvckVhY2goKGZpZWxkKSA9PiB7XHJcbiAgICAgICAgZmllbGQucmVtb3ZlQ2xhc3MoJ2lucHV0LWVycm9yJyk7XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgZmllbGQudmFsKCkgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC52YWwoKS50cmltKCkgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICBmaWVsZC5hZGRDbGFzcygnaW5wdXQtZXJyb3InKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiBmaWVsZC52YWwoKSA9PT0gJ3VuZGVmaW5lZCcpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBmaWVsZC5hZGRDbGFzcygnaW5wdXQtZXJyb3InKVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGVycm9yRmllbGRzID0gZm9ybS5maW5kKCcuaW5wdXQtZXJyb3InKTtcclxuXHJcbiAgICByZXR1cm4gZXJyb3JGaWVsZHMubGVuZ3RoID09PSAwO1xyXG59XHJcblxyXG5cclxuJCgnLmZvcm0nKS5zdWJtaXQoZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgY29uc3QgZm9ybSA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IG5hbWUgPSBmb3JtLmZpbmQoXCJbbmFtZT0nbmFtZSddXCIpO1xyXG4gICAgY29uc3QgcGhvbmUgPSBmb3JtLmZpbmQoXCJbbmFtZT0ncGhvbmUnXVwiKTtcclxuICAgIGNvbnN0IGNvbW1lbnQgPSBmb3JtLmZpbmQoXCJbbmFtZT0nY29tbWVudCddXCIpO1xyXG4gICAgY29uc3QgdG8gPSBmb3JtLmZpbmQoXCJbbmFtZT0ndG8nXVwiKTtcclxuXHJcbiAgICBjb25zdCBwb3B1cCA9ICQoJyNwb3B1cCcpO1xyXG4gICAgY29uc3QgY29udGVudCA9IHBvcHVwLmZpbmQoJy5wb3B1cF9fdGV4dCcpO1xyXG4gICAgcG9wdXAucmVtb3ZlQ2xhc3MoJ2Vycm9yLXBvcHVwJyk7XHJcblxyXG4gICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRlRmllbGRzKGZvcm0sIFtuYW1lLCBwaG9uZSwgY29tbWVudCwgdG9dKTtcclxuICAgIGNvbnN0IHN0YXR1c0FqYXhGb3JtID0ge307XHJcblxyXG4gICAgaWYgKGlzVmFsaWQpIHtcclxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOidodHRwczovL3dlYmRldi1hcGkubG9mdHNjaG9vbC5jb20vc2VuZG1haWwnLFxyXG4gICAgICAgICAgICBtZXRob2Q6ICdwb3N0JyxcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgbmFtZTogbmFtZS52YWwoKSxcclxuICAgICAgICAgICAgICAgIHBob25lOiBwaG9uZS52YWwoKSxcclxuICAgICAgICAgICAgICAgIGNvbW1lbnQ6IGNvbW1lbnQudmFsKCksXHJcbiAgICAgICAgICAgICAgICB0bzogdG8udmFsKCkudHJpbSgpLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBlcnJvcjogZGF0YSA9PiB7fVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXF1ZXN0LmRvbmUoZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnRlbnQudGV4dChkYXRhLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICBzdGF0dXNBamF4Rm9ybS5kb25lID0gdHJ1ZTtcclxuICAgICAgICAgICAgcG9wdXAuZmluZCgnLnBvcHVwX190ZXh0JykucmVtb3ZlQ2xhc3MoJ2Vycm9yLXBvcHVwJyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcXVlc3QuZmFpbChkYXRhID0+IHtcclxuICAgICAgICAgICAgc3RhdHVzQWpheEZvcm0uZG9uZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gZGF0YS5yZXNwb25zZUpTT04ubWVzc2FnZTtcclxuICAgICAgICAgICAgY29udGVudC50ZXh0KG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICBwb3B1cC5maW5kKCcucG9wdXBfX3RleHQnKS5hZGRDbGFzcygnZXJyb3ItcG9wdXAnKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxdWVzdC5hbHdheXMoKCkgPT4ge1xyXG4gICAgICAgICAgICAkLmZhbmN5Ym94Lm9wZW4oe1xyXG4gICAgICAgICAgICAgICAgc3JjOiAnI3BvcHVwJyxcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdpbmxpbmUnLFxyXG5cclxuICAgICAgICAgICAgICAgIGFmdGVyQ2xvc2U6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzQWpheEZvcm0uZG9uZSlcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1bMF0ucmVzZXQoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn0pO1xyXG5cclxuJCgnLmZvcm1fX2lucHV0JykuY2hhbmdlKGUgPT4ge1xyXG4gICAgJHRoaXMgPSAkKGUuY3VycmVudFRhcmdldCk7XHJcbiAgICAkdGhpcy5yZW1vdmVDbGFzcygnaW5wdXQtZXJyb3InKTtcclxufSk7XHJcblxyXG5cclxuJCgnLmpzLWJ0bi1zdWJtaXQnKS5jbGljayhlID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICAkLmZhbmN5Ym94LmNsb3NlKCk7XHJcbn0pO1xyXG4iLCJjb25zdCBidXJnZXJCdG4gPSAkKCcjYnVyZ2VyJyk7XHJcbmNvbnN0IGhhbWJ1cmdlciA9ICQoJy5oYW1idXJnZXItcGFuZWwnKTtcclxuY29uc3QgY2xvc2VCdG4gPSAkKCcuY2xvc2UtYnRuJyk7XHJcbmNvbnN0IGhhbWJMaW5rID0gJCgnLmhhbWJ1cmdlci1wYW5lbF9fbGluaycpO1xyXG5cclxuZnVuY3Rpb24gc3dpdGNoZXIoZWxlbSwgY2xhc3NOYW1lKSB7XHJcbiAgICBlbGVtLnRvZ2dsZUNsYXNzKGNsYXNzTmFtZSk7XHJcbn1cclxuXHJcbmxldCBmbGFnID0gdHJ1ZTtcclxuXHJcbmJ1cmdlckJ0bi5jbGljayggZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgaWYoZmxhZykge1xyXG4gICAgICAgIGZsYWcgPSBmYWxzZTtcclxuICAgICAgICBoYW1idXJnZXIucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaGVyKGhhbWJ1cmdlciwgJ2lzQWN0aXZlJyk7XHJcbiAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgIH0sIDUwMCk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuY2xvc2VCdG4uY2xpY2soIGUgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuICAgIGlmKGZsYWcpIHtcclxuICAgICAgICBmbGFnID0gZmFsc2U7XHJcbiAgICAgICAgaGFtYnVyZ2VyLnJlbW92ZUNsYXNzKCdpc0FjdGl2ZScpO1xyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaGVyKGhhbWJ1cmdlciwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICBmbGFnID0gdHJ1ZTtcclxuICAgICAgICB9LCA1MDApO1xyXG4gICAgfVxyXG5cclxufSk7XHJcblxyXG5oYW1iTGluay5jbGljayggZSA9PiB7XHJcbiAgICBoYW1idXJnZXIucmVtb3ZlQ2xhc3MoJ2lzQWN0aXZlJyk7XHJcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHN3aXRjaGVyKGhhbWJ1cmdlciwgJ2hpZGRlbicpO1xyXG4gICAgICAgIGZsYWcgPSBmYWxzZTtcclxuICAgICAgICB9LCA1MDApO1xyXG59KTtcclxuIiwiXHJcbiQoXCIuaW5jLXBhbmVsXCIpLmVhY2goZnVuY3Rpb24gKCkge1xyXG4gICAgJCh0aGlzKS5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgJCh0aGlzKS5maW5kKFwiLmluYy1tZW51XCIpLmNzcyh7ZGlzcGxheTogJ2ZsZXgnfSk7XHJcbiAgICB9KTtcclxuICAgICQodGhpcykub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgJCh0aGlzKS5maW5kKFwiLmluYy1tZW51XCIpLmNzcyh7ZGlzcGxheTogJ25vbmUnfSk7XHJcbiAgICB9KTtcclxufSlcclxuXHJcbiIsImxldCBwbGF5ZXI7XHJcbmNvbnN0IHBsYXllckNvbnRhaW5lciA9ICQoXCIucGxheWVyXCIpO1xyXG5sZXQgZj0gMTtcclxuXHJcbmxldCBldmVudHNJbml0ID0gKCkgPT4ge1xyXG4gICAgJChcIi5wbGF5ZXJfX3N0YXJ0XCIpLmNsaWNrKGUgPT4ge1xyXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICAgICAgaWYgKHBsYXllckNvbnRhaW5lci5oYXNDbGFzcyhcInBhdXNlZFwiKSkge1xyXG4gICAgICAgICAgICBwbGF5ZXIucGF1c2VWaWRlbygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHBsYXllci5wbGF5VmlkZW8oKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICAkKFwiLnBsYXllcl9fcGxheWJhY2tcIikuY2xpY2soZSA9PiB7XHJcbiAgICAgICAgY29uc3QgYmFyID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgICAgIGNvbnN0IGNsaWNrZWRQb3NpdGlvbiA9IGUub3JpZ2luYWxFdmVudC5sYXllclg7XHJcbiAgICAgICAgY29uc3QgbmV3QnV0dG9uUG9zaXRpb25QZXJjZW50ID0gKGNsaWNrZWRQb3NpdGlvbiAvIGJhci53aWR0aCgpKSAqIDEwMDtcclxuICAgICAgICBjb25zdCBuZXdQbGF5YmFja1Bvc2l0aW9uU2VjID1cclxuICAgICAgICAgICAgKHBsYXllci5nZXREdXJhdGlvbigpIC8gMTAwKSAqIG5ld0J1dHRvblBvc2l0aW9uUGVyY2VudDtcclxuXHJcbiAgICAgICAgJChcIi5wbGF5ZXJfX3BsYXliYWNrLWJ1dHRvblwiKS5jc3Moe1xyXG4gICAgICAgICAgICBsZWZ0OiBgJHtuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnR9JWBcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcGxheWVyLnNlZWtUbyhuZXdQbGF5YmFja1Bvc2l0aW9uU2VjKTtcclxuICAgIH0pO1xyXG5cclxuICAgICQoXCIucGxheWVyX19zcGxhc2hcIikuY2xpY2soZSA9PiB7XHJcbiAgICAgICAgcGxheWVyLnBsYXlWaWRlbygpO1xyXG4gICAgfSlcclxufTtcclxuXHJcbmNvbnN0IGZvcm1hdFRpbWUgPSB0aW1lU2VjID0+IHtcclxuICAgIGNvbnN0IHJvdW5kVGltZSA9IE1hdGgucm91bmQodGltZVNlYyk7XHJcblxyXG4gICAgY29uc3QgbWludXRlcyA9IGFkZFplcm8oTWF0aC5mbG9vcihyb3VuZFRpbWUgLyA2MCkpO1xyXG4gICAgY29uc3Qgc2Vjb25kcyA9IGFkZFplcm8ocm91bmRUaW1lIC0gbWludXRlcyAqIDYwKTtcclxuXHJcbiAgICBmdW5jdGlvbiBhZGRaZXJvKG51bSkge1xyXG4gICAgICAgIHJldHVybiBudW0gPCAxMCA/IGAwJHtudW19YCA6IG51bTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gYCR7bWludXRlc30gOiAke3NlY29uZHN9YDtcclxufTtcclxuXHJcbmNvbnN0IG9uUGxheWVyUmVhZHkgPSAoKSA9PiB7XHJcbiAgICBsZXQgaW50ZXJ2YWw7XHJcbiAgICBjb25zdCBkdXJhdGlvblNlYyA9IHBsYXllci5nZXREdXJhdGlvbigpO1xyXG5cclxuICAgICQoXCIucGxheWVyX19kdXJhdGlvbi1lc3RpbWF0ZVwiKS50ZXh0KGZvcm1hdFRpbWUoZHVyYXRpb25TZWMpKTtcclxuXHJcbiAgICBpZiAodHlwZW9mIGludGVydmFsICE9PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XHJcbiAgICB9XHJcblxyXG4gICAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY29tcGxldGVkU2VjID0gcGxheWVyLmdldEN1cnJlbnRUaW1lKCk7XHJcbiAgICAgICAgY29uc3QgY29tcGxldGVkUGVyY2VudCA9IChjb21wbGV0ZWRTZWMgLyBkdXJhdGlvblNlYykgKiAxMDA7XHJcblxyXG4gICAgICAgICQoXCIucGxheWVyX19wbGF5YmFjay1idXR0b25cIikuY3NzKHtcclxuICAgICAgICAgICAgbGVmdDogYCR7Y29tcGxldGVkUGVyY2VudH0lYFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkKFwiLnBsYXllcl9fZHVyYXRpb24tY29tcGxldGVkXCIpLnRleHQoZm9ybWF0VGltZShjb21wbGV0ZWRTZWMpKTtcclxuICAgIH0sIDEwMDApO1xyXG59O1xyXG5cclxuY29uc3Qgb25QbGF5ZXJTdGF0ZUNoYW5nZSA9IGV2ZW50ID0+IHtcclxuICAgIC8qXHJcbiAgICAgIC0xICjQstC+0YHQv9GA0L7QuNC30LLQtdC00LXQvdC40LUg0LLQuNC00LXQviDQvdC1INC90LDRh9Cw0YLQvilcclxuICAgICAgMCAo0LLQvtGB0L/RgNC+0LjQt9Cy0LXQtNC10L3QuNC1INCy0LjQtNC10L4g0LfQsNCy0LXRgNGI0LXQvdC+KVxyXG4gICAgICAxICjQstC+0YHQv9GA0L7QuNC30LLQtdC00LXQvdC40LUpXHJcbiAgICAgIDIgKNC/0LDRg9C30LApXHJcbiAgICAgIDMgKNCx0YPRhNC10YDQuNC30LDRhtC40Y8pXHJcbiAgICAgIDUgKNCy0LjQtNC10L4g0L/QvtC00LDRjtGCINGA0LXQv9C70LjQutC4KS5cclxuICAgICovXHJcbiAgICBzd2l0Y2ggKGV2ZW50LmRhdGEpIHtcclxuICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgIHBsYXllckNvbnRhaW5lci5hZGRDbGFzcyhcImFjdGl2ZVwiKTtcclxuICAgICAgICAgICAgcGxheWVyQ29udGFpbmVyLmFkZENsYXNzKFwicGF1c2VkXCIpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgY2FzZSAyOlxyXG4gICAgICAgICAgICBwbGF5ZXJDb250YWluZXIucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XHJcbiAgICAgICAgICAgIHBsYXllckNvbnRhaW5lci5yZW1vdmVDbGFzcyhcInBhdXNlZFwiKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbn07XHJcblxyXG5mdW5jdGlvbiBvbllvdVR1YmVJZnJhbWVBUElSZWFkeSgpIHtcclxuICAgIHBsYXllciA9IG5ldyBZVC5QbGF5ZXIoXCJ5dC1wbGF5ZXJcIiwge1xyXG4gICAgICAgIGhlaWdodDogXCI0MDVcIixcclxuICAgICAgICB3aWR0aDogXCI2NjBcIixcclxuICAgICAgICB2aWRlb0lkOiBcIkxYYjNFS1dzSW5RXCIsXHJcbiAgICAgICAgZXZlbnRzOiB7XHJcbiAgICAgICAgICAgIG9uUmVhZHk6IG9uUGxheWVyUmVhZHksXHJcbiAgICAgICAgICAgIG9uU3RhdGVDaGFuZ2U6IG9uUGxheWVyU3RhdGVDaGFuZ2VcclxuICAgICAgICB9LFxyXG4gICAgICAgIHBsYXllclZhcnM6IHtcclxuICAgICAgICAgICAgY29udHJvbHM6IDAsXHJcbiAgICAgICAgICAgIGRpc2FibGVrYjogMCxcclxuICAgICAgICAgICAgc2hvd2luZm86IDAsXHJcbiAgICAgICAgICAgIHJlbDogMCxcclxuICAgICAgICAgICAgYXV0b3BsYXk6IDAsXHJcbiAgICAgICAgICAgIG1vZGVzdGJyYW5kaW5nOiAwXHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV2ZW50c0luaXQoKTtcclxuIiwibGV0IG15TWFwO1xyXG5jb25zdCBpbml0ID0gKCkgPT4ge1xyXG4gICAgbXlNYXAgPSBuZXcgeW1hcHMuTWFwKFwibWFwXCIsIHtcclxuICAgICAgICBjZW50ZXI6IFs1OS45MzkxNjk5ODY5MjE3NCwgMzAuMzA5MDE1MDk2NzMyNjIyXSxcclxuICAgICAgICB6b29tOiAxMSxcclxuICAgICAgICBjb250cm9sczogW10sXHJcbiAgICB9KTtcclxuXHJcbiAgICBsZXQgY29vcmRzID0gW1xyXG4gICAgICAgICAgICBbNTkuOTQ1NTQzMjc5ODkyODcsIDMwLjM4OTM1MjYyMTE0NjY4XSxcclxuICAgICAgICAgICAgWzU5LjkxMTQyMzIzNTYzOTA5LCAzMC41MDAyNDU4NzA2NTg0MV0sXHJcbiAgICAgICAgICAgIFs1OS44ODY5MzE2MTc4NDYwNiwgMzAuMzE5NjU4MTAyMTAzNzEzXSxcclxuICAgICAgICAgICAgWzU5Ljk3MDMzNTc0ODIxNjcyLCAzMC4zMTUxOTQ5MDYzMDI5MjRdLFxyXG4gICAgICAgIF0sXHJcbiAgICAgICAgbXlDb2xsZWN0aW9uID0gbmV3IHltYXBzLkdlb09iamVjdENvbGxlY3Rpb24oe30sIHtcclxuICAgICAgICAgICAgZHJhZ2dhYmxlOiBmYWxzZSxcclxuICAgICAgICAgICAgaWNvbkxheW91dDogJ2RlZmF1bHQjaW1hZ2UnLFxyXG4gICAgICAgICAgICBpY29uSW1hZ2VIcmVmOiAnLi9pbWcvaWNvbnMvbWFya2VyLnN2ZycsXHJcbiAgICAgICAgICAgIGljb25JbWFnZVNpemU6IFs0NiwgNTddLFxyXG4gICAgICAgICAgICBpY29uSW1hZ2VPZmZzZXQ6IFstMzUsIC01Ml1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvb3Jkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIG15Q29sbGVjdGlvbi5hZGQobmV3IHltYXBzLlBsYWNlbWFyayhjb29yZHNbaV0pKTtcclxuICAgIH1cclxuXHJcbiAgICBteU1hcC5nZW9PYmplY3RzLmFkZChteUNvbGxlY3Rpb24pO1xyXG5cclxuICAgIG15TWFwLmJlaGF2aW9ycy5kaXNhYmxlKCdzY3JvbGxab29tJyk7XHJcbn07XHJcblxyXG55bWFwcy5yZWFkeShpbml0KTtcclxuIiwiXHJcbmZ1bmN0aW9uIGFjY29yZChzZWxlY3Rvcikge1xyXG4gICAgY29uc3QgYWNjb3JkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XHJcbiAgICBjb25zdCBpdGVtcyA9IGFjY29yZC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1saXN0XScpLmNoaWxkcmVuO1xyXG4gICAgY29uc3QgY2xvc2VCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuYWNjb3JkX19jbG9zZS1idG4nKTtcclxuXHJcbiAgICBhY2NvcmQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKSB7XHJcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCAoKTtcclxuICAgICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldC5jbG9zZXN0KCdbZGF0YV0nKTtcclxuXHJcbiAgICAgICAgaWYgKGUudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnYWNjb3JkX19jbG9zZS1idG4nKSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGUudGFyZ2V0LnBhcmVudE5vZGUucGFyZW50Tm9kZS5wYXJlbnROb2RlLmNsYXNzTGlzdC5yZW1vdmUoJ2l0ZW0tYWN0aXZlJylcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKCF0YXJnZXQpIHJldHVybjtcclxuXHJcbiAgICAgICAgY29uc3QgaXRlbSA9IHRhcmdldC5wYXJlbnROb2RlO1xyXG5cclxuICAgICAgICBpZiAoaXRlbS5jbGFzc0xpc3QuY29udGFpbnMoJ2l0ZW0tYWN0aXZlJykpIHtcclxuICAgICAgICAgICAgaXRlbS5jbGFzc0xpc3QucmVtb3ZlKCdpdGVtLWFjdGl2ZScpO1xyXG4gICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaXRlbXNbaV0uY2xhc3NMaXN0LnJlbW92ZSgnaXRlbS1hY3RpdmUnKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKCdpdGVtLWFjdGl2ZScpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxufVxyXG5cclxuYWNjb3JkICgnI2FjY29yZC1tZW51JylcclxuIiwiY29uc3Qgc2VjdGlvbnMgPSAkKFwic2VjdGlvblwiKTtcclxuY29uc3QgZGlzcGxheSA9ICQoXCIubWFpbmNvbnRlbnRcIik7XHJcbmNvbnN0IHNpZGVNZW51ID0gJChcIi5maXhlZC1tZW51XCIpO1xyXG5jb25zdCBtZW51SXRlbXMgPSBzaWRlTWVudS5maW5kKFwiLmZpeGVkLW1lbnVfX2l0ZW1cIik7XHJcblxyXG5jb25zdCBtb2JpbGVkID0gbmV3IE1vYmlsZURldGVjdCh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCk7XHJcbmNvbnN0IGlzTW9iaWxlID0gbW9iaWxlZC5tb2JpbGUoKTtcclxuXHJcbmxldCBpblNjcm9sbCA9IGZhbHNlO1xyXG5cclxuc2VjdGlvbnMuZmlyc3QoKS5hZGRDbGFzcyhcImFjdGl2ZVwiKTtcclxuXHJcbmNvbnN0IGNvdW50U2VjdGlvblBvc2l0aW9uID0gc2VjdGlvbkVxID0+IHtcclxuXHJcbiAgICByZXR1cm4gc2VjdGlvbkVxICogLTEwMDtcclxuXHJcbiAgICAvL2xldCBoZWkgPSBhY3RpdmVTZWN0aW9uLm5leHQoKS5oZWlnaHQoKTtcclxufTtcclxuXHJcbmNvbnN0IGNoYW5nZU1lbnVUaGVtZUZvclNlY3Rpb24gPSAoc2VjdGlvbkVxKSA9PiB7XHJcbiAgICBjb25zdCBjdXJyZW50U2VjdGlvbiA9IHNlY3Rpb25zLmVxKHNlY3Rpb25FcSk7XHJcbiAgICBjb25zdCBtZW51VGhlbWUgPSBjdXJyZW50U2VjdGlvbi5hdHRyKFwiZGF0YS1zaWRlbWVudS10aGVtZVwiKTtcclxuICAgIGNvbnN0IGFjdGl2ZUNsYXNzID0gXCJmaXhlZC1tZW51LS1zaGFkb3dlZFwiO1xyXG5cclxuICAgIGlmIChtZW51VGhlbWUgPT09IFwiYmxhY2tcIikge1xyXG4gICAgICAgIHNpZGVNZW51LmFkZENsYXNzKGFjdGl2ZUNsYXNzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2lkZU1lbnUucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuY29uc3QgcmVzZXRBY3RpdmVDbGFzc0Zvckl0ZW0gPSAoaXRlbXMsIGl0ZW1FcSwgYWN0aXZlQ2xhc3MpID0+IHtcclxuICAgIGl0ZW1zLmVxKGl0ZW1FcSkuYWRkQ2xhc3MoYWN0aXZlQ2xhc3MpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpO1xyXG59XHJcblxyXG5jb25zdCBwZXJmb3JtVHJhbnNpdGlvbiA9IHNlY3Rpb25FcSA9PiB7XHJcblxyXG4gICAgaWYgKGluU2Nyb2xsKSByZXR1cm47XHJcblxyXG4gICAgY29uc3QgdHJhbnNpdGlvbk92ZXIgPSAxMDAwO1xyXG4gICAgY29uc3QgbW91c2VJbmVydGlhT3ZlciA9IDMwMDtcclxuXHJcbiAgICBpblNjcm9sbCA9IHRydWU7XHJcblxyXG4gICAgY29uc3QgcG9zaXRpb24gPSBjb3VudFNlY3Rpb25Qb3NpdGlvbihzZWN0aW9uRXEpO1xyXG5cclxuICAgIGNoYW5nZU1lbnVUaGVtZUZvclNlY3Rpb24oc2VjdGlvbkVxKTtcclxuXHJcblxyXG4gICAgZGlzcGxheS5jc3Moe1xyXG4gICAgICAgIHRyYW5zZm9ybTogYHRyYW5zbGF0ZVkoJHtwb3NpdGlvbn0lKWBcclxuICAgIH0pO1xyXG5cclxuICAgIHJlc2V0QWN0aXZlQ2xhc3NGb3JJdGVtKHNlY3Rpb25zLCBzZWN0aW9uRXEsIFwiYWN0aXZlXCIpO1xyXG4gICAgc2VjdGlvbnMuZXEoc2VjdGlvbkVxKS5hZGRDbGFzcyhcImFjdGl2ZVwiKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xyXG5cclxuXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICBpblNjcm9sbCA9IGZhbHNlO1xyXG5cclxuICAgICAgICByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShtZW51SXRlbXMsIHNlY3Rpb25FcSwgXCJmaXhlZC1tZW51X19pdGVtLS1hY3RpdmVcIik7XHJcblxyXG4gICAgfSwgdHJhbnNpdGlvbk92ZXIgKyBtb3VzZUluZXJ0aWFPdmVyKVxyXG5cclxufTtcclxuXHJcbmNvbnN0IHNjcm9sbFZpZXdwb3J0ID0gZGlyZWN0aW9uID0+IHtcclxuICAgIGNvbnN0IGFjdGl2ZVNlY3Rpb24gPSBzZWN0aW9ucy5maWx0ZXIoXCIuYWN0aXZlXCIpO1xyXG4gICAgY29uc3QgbmV4dFNlY3Rpb24gPSBhY3RpdmVTZWN0aW9uLm5leHQoKTtcclxuICAgIGNvbnN0IHByZXZTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5wcmV2KCk7XHJcblxyXG4gICAgaWYgKGRpcmVjdGlvbiA9PT0gXCJuZXh0XCIgJiYgbmV4dFNlY3Rpb24ubGVuZ3RoKSB7XHJcbiAgICAgICAgcGVyZm9ybVRyYW5zaXRpb24obmV4dFNlY3Rpb24uaW5kZXgoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGRpcmVjdGlvbiA9PT0gXCJwcmV2XCIgJiYgcHJldlNlY3Rpb24ubGVuZ3RoKSB7XHJcbiAgICAgICAgcGVyZm9ybVRyYW5zaXRpb24ocHJldlNlY3Rpb24uaW5kZXgoKSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG4kKHdpbmRvdykub24oXCJ3aGVlbFwiLCBlID0+IHtcclxuICAgIGNvbnN0IGRlbHRhWSA9IGUub3JpZ2luYWxFdmVudC5kZWx0YVk7XHJcblxyXG4gICAgaWYgKGRlbHRhWSA+IDApIHtcclxuICAgICAgICBzY3JvbGxWaWV3cG9ydChcIm5leHRcIik7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGRlbHRhWSA8IDApIHtcclxuICAgICAgICBzY3JvbGxWaWV3cG9ydChcInByZXZcIik7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuJCh3aW5kb3cpLm9uKFwia2V5ZG93blwiLCBlID0+IHtcclxuXHJcbiAgICBjb25zdCB0YWduYW1lID0gZS50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgY29uc3QgdXNlclR5cGluZ0luSW5wdXRzID0gdGFnbmFtZSA9PT0gXCJpbnB1dFwiIHx8IHRhZ25hbWUgPT09IFwidGV4dGFyZWFcIjtcclxuICAgIGlmICh1c2VyVHlwaW5nSW5JbnB1dHMpIHJldHVybjtcclxuXHJcbiAgICBzd2l0Y2ggKGUua2V5Q29kZSkge1xyXG4gICAgICAgIGNhc2UgMzg6XHJcbiAgICAgICAgICAgIHNjcm9sbFZpZXdwb3J0KFwicHJldlwiKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSA0MDpcclxuICAgICAgICAgICAgc2Nyb2xsVmlld3BvcnQoXCJuZXh0XCIpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgIH1cclxufSk7XHJcblxyXG4kKFwiLndyYXBwZXJcIikub24oXCJ0b3VjaG1vdmVcIiwgZSA9PiBlLnByZXZlbnREZWZhdWx0KCkpO1xyXG5cclxuJChcIltkYXRhLXNjcm9sbC10b11cIikuY2xpY2soZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgY29uc3QgJHRoaXMgPSAkKGUuY3VycmVudFRhcmdldCk7XHJcbiAgICBjb25zdCB0YXJnZXQgPSAkdGhpcy5hdHRyKFwiZGF0YS1zY3JvbGwtdG9cIik7XHJcbiAgICBjb25zdCByZXFTZWN0aW9uID0gJChgW2RhdGEtc2VjdGlvbi1pZD0ke3RhcmdldH1dYCk7XHJcblxyXG4gICAgcGVyZm9ybVRyYW5zaXRpb24ocmVxU2VjdGlvbi5pbmRleCgpKTtcclxuXHJcbn0pO1xyXG5cclxuaWYgKGlzTW9iaWxlKVxyXG57XHJcbiAgICAkKFwiYm9keVwiKS5zd2lwZSh7XHJcbiAgICAgICAgc3dpcGU6IGZ1bmN0aW9uIChldmVudCwgZGlyZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09IFwidXBcIilcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgc2Nyb2xsVmlld3BvcnQoXCJuZXh0XCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09IFwiZG93blwiKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBzY3JvbGxWaWV3cG9ydChcInByZXZcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuXHJcbiJdfQ==
